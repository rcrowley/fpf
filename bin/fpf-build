#!/bin/sh

#/ Usage: fpf-build [-A|-a<arch>] -d<dirname> -n<name> -v<version> <package>
#/   -A          package is architecture-independent
#/   -a<arch>    pointer size (32 or 64) on target systems
#/   -d<dirname> directory with files to be packaged
#/   -n<name>    package name
#/   -v<version> package version number
#/   <package>   package pathname

set -e

ARCH="$({ dpkg --print-architecture || rpm --eval "%_arch"; } 2>"/dev/null")"

usage() {
	grep "^#/" "$0" | cut -c4- 1>&2
	exit "$1"
}
while [ "$#" -gt 0 ]
do
	case "$1" in
		-A) ARCH="" shift;;
		-a|--arch) ARCH="$2" shift 2;;
		-a*) ARCH="$(echo $1 | cut -c3-)" shift;;
		--arch=*) ARCH="$(echo $1 | cut -c8-)" shift;;
		-d|--dirname) DIRNAME="$2" shift 2;;
		-d*) DIRNAME="$(echo $1 | cut -c3-)" shift;;
		--dirname=*) DIRNAME="$(echo $1 | cut -c11-)" shift;;
		-n|--name) NAME="$2" shift 2;;
		-n*) NAME="$(echo $1 | cut -c3-)" shift;;
		--name=*) NAME="$(echo $1 | cut -c8-)" shift;;
		-v|--version) VERSION="$2" shift 2;;
		-v*) VERSION="$(echo $1 | cut -c3-)" shift;;
		--version=*) VERSION="$(echo $1 | cut -c11-)" shift;;
		-h|--help) usage 0;;
		-*) usage 1;;
		*) break;;
	esac
done
PACKAGE="$1"
[ -z "$DIRNAME" -o -z "$NAME" -o -z "$VERSION" -o -z "$PACKAGE" ] && usage 1

TMP="$(mktemp -d)"
trap "rm -rf \"$TMP\"" EXIT INT TERM
git init --bare -q "$TMP/work.git"
rm -rf \
	"$TMP/work.git/branches" \
	"$TMP/work.git/hooks" \
	"$TMP/work.git/info" \
	"$TMP/work.git/logs" \
	"$TMP/work.git/objects/info" \
	"$TMP/work.git/objects/pack" \
	"$TMP/work.git/refs/tags"
# TODO User-specified $TMP/work.git/description.
export GIT_DIR="$TMP/work.git"
[ -z "$ARCH" ] || git config --add "fpf.arch" "$ARCH"
git config --add "fpf.name" "$NAME"
git config --add "fpf.version" "$VERSION"

. "$(dirname "$(dirname "$0")")/lib/fpf.sh"

TREE="$(_git_write_tree "$DIRNAME")"
COMMIT="$(_git_commit "$TREE")"
git update-ref "refs/heads/$NAME" "$COMMIT"
git symbolic-ref "HEAD" "refs/heads/$NAME"

tar cf "$PACKAGE" -C "$TMP/work.git" "."
